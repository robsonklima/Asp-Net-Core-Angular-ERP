<?xml version="1.0" encoding="utf-8"?>
<Report xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition" xmlns:rd="http://schemas.microsoft.com/SQLServer/reporting/reportdesigner">
  <DataSources>
    <DataSource Name="SAT">
      <rd:DataSourceID>d365d57d-36b3-4dae-b52d-d310cb8dc479</rd:DataSourceID>
      <DataSourceReference>SAT</DataSourceReference>
    </DataSource>
  </DataSources>
  <rd:ReportID>326bd881-852a-4e1a-a2f3-3f23510e4aee</rd:ReportID>
  <Width>5in</Width>
  <Body>
    <Height>1.17in</Height>
    <ColumnSpacing>0.5in</ColumnSpacing>
    <ReportItems>
      <Textbox Name="textbox1">
        <Style>
          <FontFamily>Tahoma</FontFamily>
          <FontSize>18pt</FontSize>
          <Color>#1c3a70</Color>
          <PaddingLeft>2pt</PaddingLeft>
          <PaddingRight>2pt</PaddingRight>
          <PaddingTop>2pt</PaddingTop>
          <PaddingBottom>2pt</PaddingBottom>
        </Style>
        <rd:DefaultName>textbox1</rd:DefaultName>
        <Value>Percentual de Defeito por Periférico e Modelo_</Value>
        <CanGrow>true</CanGrow>
        <Height>0.33in</Height>
      </Textbox>
      <Matrix Name="matrix1">
        <Top>0.33in</Top>
        <RowGroupings>
          <RowGrouping>
            <DynamicRows>
              <Grouping Name="matrix1_nometipocausa">
                <GroupExpressions>
                  <GroupExpression>=Fields!nometipocausa.Value</GroupExpression>
                </GroupExpressions>
              </Grouping>
              <Sorting>
                <SortBy>
                  <SortExpression>=Fields!nometipocausa.Value</SortExpression>
                </SortBy>
              </Sorting>
              <ReportItems>
                <Textbox Name="nometipocausa">
                  <Style>
                    <FontFamily>Tahoma</FontFamily>
                    <FontSize>10pt</FontSize>
                    <Color>White</Color>
                    <BackgroundColor>#60759b</BackgroundColor>
                    <BorderStyle>
                      <Default>Solid</Default>
                    </BorderStyle>
                    <BorderColor>
                      <Default>DimGray</Default>
                    </BorderColor>
                    <PaddingLeft>2pt</PaddingLeft>
                    <PaddingRight>2pt</PaddingRight>
                    <PaddingTop>2pt</PaddingTop>
                    <PaddingBottom>2pt</PaddingBottom>
                  </Style>
                  <rd:DefaultName>nometipocausa</rd:DefaultName>
                  <Value>=Fields!nometipocausa.Value</Value>
                  <CanGrow>true</CanGrow>
                  <Height>0.21in</Height>
                  <Width>1in</Width>
                </Textbox>
              </ReportItems>
            </DynamicRows>
            <Width>1in</Width>
          </RowGrouping>
        </RowGroupings>
        <MatrixRows>
          <MatrixRow>
            <MatrixCells>
              <MatrixCell>
                <ReportItems>
                  <Textbox Name="textbox2">
                    <Style>
                      <FontFamily>Tahoma</FontFamily>
                      <FontSize>10pt</FontSize>
                      <BorderStyle>
                        <Default>Solid</Default>
                      </BorderStyle>
                      <BorderColor>
                        <Default>DimGray</Default>
                      </BorderColor>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                    <rd:DefaultName>textbox2</rd:DefaultName>
                    <Value>=Sum(Fields!qtd.Value)</Value>
                    <CanGrow>true</CanGrow>
                    <Height>0.21in</Height>
                    <Width>1in</Width>
                  </Textbox>
                </ReportItems>
              </MatrixCell>
              <MatrixCell>
                <ReportItems>
                  <Textbox Name="textbox3">
                    <Style>
                      <FontFamily>Tahoma</FontFamily>
                      <FontSize>10pt</FontSize>
                      <BorderStyle>
                        <Default>Solid</Default>
                      </BorderStyle>
                      <BorderColor>
                        <Default>DimGray</Default>
                      </BorderColor>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                    <rd:DefaultName>textbox3</rd:DefaultName>
                    <Value>=Sum(Fields!per.Value)</Value>
                    <CanGrow>true</CanGrow>
                    <Height>0.21in</Height>
                    <Width>1in</Width>
                  </Textbox>
                </ReportItems>
              </MatrixCell>
            </MatrixCells>
            <Height>0.21in</Height>
          </MatrixRow>
        </MatrixRows>
        <Corner>
          <ReportItems>
            <Textbox Name="textbox4">
              <Style>
                <FontFamily>Tahoma</FontFamily>
                <FontSize>10pt</FontSize>
                <BorderStyle>
                  <Default>Solid</Default>
                </BorderStyle>
                <BorderColor>
                  <Default>DimGray</Default>
                </BorderColor>
                <PaddingLeft>2pt</PaddingLeft>
                <PaddingRight>2pt</PaddingRight>
                <PaddingTop>2pt</PaddingTop>
                <PaddingBottom>2pt</PaddingBottom>
              </Style>
              <rd:DefaultName>textbox4</rd:DefaultName>
              <Value>
              </Value>
              <CanGrow>true</CanGrow>
              <Height>0.21in</Height>
            </Textbox>
          </ReportItems>
        </Corner>
        <DataSetName>DataSet1</DataSetName>
        <MatrixColumns>
          <MatrixColumn>
            <Width>1in</Width>
          </MatrixColumn>
          <MatrixColumn>
            <Width>1in</Width>
          </MatrixColumn>
        </MatrixColumns>
        <ColumnGroupings>
          <ColumnGrouping>
            <DynamicColumns>
              <Grouping Name="matrix1_nomeequip">
                <GroupExpressions>
                  <GroupExpression>=Fields!nomeequip.Value</GroupExpression>
                </GroupExpressions>
              </Grouping>
              <Sorting>
                <SortBy>
                  <SortExpression>=Fields!nomeequip.Value</SortExpression>
                </SortBy>
              </Sorting>
              <ReportItems>
                <Textbox Name="nomeequip">
                  <Style>
                    <FontFamily>Tahoma</FontFamily>
                    <FontSize>10pt</FontSize>
                    <Color>White</Color>
                    <BackgroundColor>#60759b</BackgroundColor>
                    <BorderStyle>
                      <Default>Solid</Default>
                    </BorderStyle>
                    <BorderColor>
                      <Default>DimGray</Default>
                    </BorderColor>
                    <PaddingLeft>2pt</PaddingLeft>
                    <PaddingRight>2pt</PaddingRight>
                    <PaddingTop>2pt</PaddingTop>
                    <PaddingBottom>2pt</PaddingBottom>
                  </Style>
                  <rd:DefaultName>nomeequip</rd:DefaultName>
                  <Value>=Fields!nomeequip.Value</Value>
                  <CanGrow>true</CanGrow>
                  <Height>0.21in</Height>
                  <Width>1in</Width>
                </Textbox>
              </ReportItems>
            </DynamicColumns>
            <Height>0.21in</Height>
          </ColumnGrouping>
          <ColumnGrouping>
            <DynamicColumns>
              <Grouping Name="matrix1_tipo_relatorio">
                <GroupExpressions>
                  <GroupExpression>=Fields!tipo_relatorio.Value</GroupExpression>
                </GroupExpressions>
              </Grouping>
              <Sorting>
                <SortBy>
                  <SortExpression>=Fields!tipo_relatorio.Value</SortExpression>
                </SortBy>
              </Sorting>
              <ReportItems>
                <Textbox Name="tipo_relatorio">
                  <Style>
                    <FontFamily>Tahoma</FontFamily>
                    <FontSize>10pt</FontSize>
                    <BackgroundColor>LightSteelBlue</BackgroundColor>
                    <BorderStyle>
                      <Default>Solid</Default>
                    </BorderStyle>
                    <BorderColor>
                      <Default>DimGray</Default>
                    </BorderColor>
                    <PaddingLeft>2pt</PaddingLeft>
                    <PaddingRight>2pt</PaddingRight>
                    <PaddingTop>2pt</PaddingTop>
                    <PaddingBottom>2pt</PaddingBottom>
                  </Style>
                  <rd:DefaultName>tipo_relatorio</rd:DefaultName>
                  <Value>=Fields!tipo_relatorio.Value</Value>
                  <CanGrow>true</CanGrow>
                  <Height>0.21in</Height>
                  <Width>1in</Width>
                </Textbox>
              </ReportItems>
            </DynamicColumns>
            <Height>0.21in</Height>
          </ColumnGrouping>
          <ColumnGrouping>
            <StaticColumns>
              <StaticColumn>
                <ReportItems>
                  <Textbox Name="textbox5">
                    <Style>
                      <FontFamily>Tahoma</FontFamily>
                      <FontSize>10pt</FontSize>
                      <BackgroundColor>#cad8ea</BackgroundColor>
                      <BorderStyle>
                        <Default>Solid</Default>
                      </BorderStyle>
                      <BorderColor>
                        <Default>DimGray</Default>
                      </BorderColor>
                      <TextAlign>Right</TextAlign>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                    <rd:DefaultName>textbox5</rd:DefaultName>
                    <Value>qtd</Value>
                    <CanGrow>true</CanGrow>
                    <Height>0.21in</Height>
                    <Width>1in</Width>
                  </Textbox>
                </ReportItems>
              </StaticColumn>
              <StaticColumn>
                <ReportItems>
                  <Textbox Name="textbox6">
                    <Style>
                      <FontFamily>Tahoma</FontFamily>
                      <FontSize>10pt</FontSize>
                      <BackgroundColor>#cad8ea</BackgroundColor>
                      <BorderStyle>
                        <Default>Solid</Default>
                      </BorderStyle>
                      <BorderColor>
                        <Default>DimGray</Default>
                      </BorderColor>
                      <TextAlign>Right</TextAlign>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                    <rd:DefaultName>textbox6</rd:DefaultName>
                    <Value>per</Value>
                    <CanGrow>true</CanGrow>
                    <Height>0.21in</Height>
                    <Width>1in</Width>
                  </Textbox>
                </ReportItems>
              </StaticColumn>
            </StaticColumns>
            <Height>0.21in</Height>
          </ColumnGrouping>
        </ColumnGroupings>
      </Matrix>
    </ReportItems>
  </Body>
  <Language>en-US</Language>
  <LeftMargin>1in</LeftMargin>
  <RightMargin>1in</RightMargin>
  <TopMargin>1in</TopMargin>
  <BottomMargin>1in</BottomMargin>
  <PageWidth>8.5in</PageWidth>
  <PageHeight>11in</PageHeight>
  <DataSets>
    <DataSet Name="DataSet1">
      <Fields>
        <Field Name="nometipocausa">
          <DataField>nometipocausa</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="nomeequip">
          <DataField>nomeequip</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="qtd">
          <DataField>qtd</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="per">
          <DataField>per</DataField>
          <rd:TypeName>System.Double</rd:TypeName>
        </Field>
        <Field Name="tipo_relatorio">
          <DataField>tipo_relatorio</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
      <Query>
        <DataSourceName>SAT</DataSourceName>
        <CommandType>Text</CommandType>
        <CommandText>--VARIAVEIS
declare		@ano varchar(4)
declare		@mes varchar(2)
declare		@data datetime
declare		@ultimodia datetime
declare		@datainicial datetime
declare		@datafinal datetime

--COMENTAR PARA TESTAR
set			@ano = substring(@anomes, 0, 5)
set			@mes = substring(@anomes, 5, 6)

--TESTES
--declare		@codcliente int
--declare		@codequip int
--declare		@codtipocausa int
--set			@ano = '2016'
--set			@mes = '05'
--set			@codcliente = 88

set			@data = getdate()
set			@ultimodia = dateadd(m,1,dateadd(d,-day(@data),@data))
set			@ultimodia = cast(convert(char(8),@ultimodia,112) as smalldatetime)

set			@datainicial = cast(@ano + '-' + @mes + '-01 00:00:01' as datetime) 
set			@datafinal = cast(@ano + '-' + @mes + '-' + cast(day(@ultimodia) as varchar) + ' 23:59:59' as datetime)

--RELATORIO
select nometipocausa, nomeequip, qtd, cast(dados.qtd as float) / (select cast(count(equipamentocontrato.codequipcontrato) as float) 
	 from		equipamentocontrato 
	 where		(1 = 1)
	 and		equipamentocontrato.codequip in (select codequip from equipamento where equipamento.codequip = dados.codequip)
	 and		equipamentocontrato.codcliente in (@codcliente)
	) as per, tipo_relatorio
	from
(
	(
		--maquina
		select			   
							tipocausa.nometipocausa									
							, (equipamento.nomeequip + ' - ' +  contratoequipamento.codmagnus) as nomeequip
							, sum(1) as qtd
							, vwc_defeito.codequip
							, 'MAQUINA' as tipo_relatorio
		from			    dbo.vwc_defeito
		inner join			tipocausa on tipocausa.codtipocausa = vwc_defeito.codtipocausa
		inner join			grupocausa on grupocausa.codgrupocausa = vwc_defeito.codgrupocausa
		inner join			ratdetalhes on ratdetalhes.codratdetalhe = vwc_defeito.codratdetalhe
		inner join			equipamento on equipamento.codequip = vwc_defeito.codequip
		inner join			contratoequipamento on vwc_defeito.codequip = contratoequipamento.codequip and vwc_defeito.codcontrato = contratoequipamento.codcontrato
		where				(1 = 1)
		and					(vwc_defeito.codrat not in (select	codrat
												from	ratdetalhes as ratdm
												where	((ratdm.coddefeito in (64,77,79,81,86,91,94,95) or ratdm.coddefeito is null)
												or		(ratdm.codacao in (5,14,15,16,18,23,24) or ratdm.codacao is null)
												or		(ratdm.codcausa in (1,7,15,41,69,73,82,241,365,416,427,445,451,459,485,513,517,526,688,820,869,879) or ratdm.codcausa is null))))
		and					tipocausa.nometipocausa not in ('9999')
		and					vwc_defeito.datahorainicio between @datainicial and @datafinal
		and					vwc_defeito.codcliente in (@codcliente)
		and					vwc_defeito.codequip in (@codequip)
		and					vwc_defeito.codtipointervencao = 2
		and					vwc_defeito.codtipocausa in (@codtipocausa)
		and					vwc_defeito.codequip not in (85, 107, 134, 147, 157, 158, 172, 204, 268)
		and					vwc_defeito.codequip in (select distinct codequip from equipamentocontrato where codcliente in (@codcliente) and indativo = 1)
		group by			equipamento.nomeequip, contratoequipamento.codmagnus, tipocausa.nometipocausa, vwc_defeito.codequip
	) 
		union
	(
		--extra maquina
		select			   
							tipocausa.nometipocausa									
							, (equipamento.nomeequip + ' - ' +  contratoequipamento.codmagnus) as nomeequip
							, sum(1) as qtd
							, vwc_defeito.codequip
							, 'EXTRA MAQUINA' as tipo_relatorio
		from			    dbo.vwc_defeito
		inner join			tipocausa on tipocausa.codtipocausa = vwc_defeito.codtipocausa
		inner join			grupocausa on grupocausa.codgrupocausa = vwc_defeito.codgrupocausa
		inner join			ratdetalhes on ratdetalhes.codratdetalhe = vwc_defeito.codratdetalhe
		inner join			equipamento on equipamento.codequip = vwc_defeito.codequip
		inner join			contratoequipamento on vwc_defeito.codequip = contratoequipamento.codequip and vwc_defeito.codcontrato = contratoequipamento.codcontrato
		where				(1 = 1)
		and					(vwc_defeito.codrat in (select	codrat
												from	ratdetalhes as ratdm
												where	((ratdm.coddefeito in (64,77,79,81,86,91,94,95) or ratdm.coddefeito is null)
												or		(ratdm.codacao in (5,14,15,16,18,23,24) or ratdm.codacao is null)
												or		(ratdm.codcausa in (1,7,15,41,69,73,82,241,365,416,427,445,451,459,485,513,517,526,688,820,869,879) or ratdm.codcausa is null))))
		and					tipocausa.nometipocausa not in ('9999')
		and					vwc_defeito.datahorainicio between @datainicial and @datafinal
		and					vwc_defeito.codcliente in (@codcliente)
		and					vwc_defeito.codequip in (@codequip)
		and					vwc_defeito.codtipointervencao = 2
		and					vwc_defeito.codtipocausa in (@codtipocausa)
		and					vwc_defeito.codequip not in (85, 107, 134, 147, 157, 158, 172, 204, 268)
		and					vwc_defeito.codequip in (select distinct codequip from equipamentocontrato where codcliente in (@codcliente) and indativo = 1)
		group by			equipamento.nomeequip, contratoequipamento.codmagnus, tipocausa.nometipocausa, vwc_defeito.codequip
	)
) as dados
order by dados.nometipocausa asc</CommandText>
        <rd:UseGenericDesigner>true</rd:UseGenericDesigner>
        <QueryParameters>
          <QueryParameter Name="@anomes">
            <Value>=Parameters!anomes.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@codcliente">
            <Value>=Parameters!codcliente.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@codequip">
            <Value>=Parameters!codequip.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@codtipocausa">
            <Value>=Parameters!codtipocausa.Value</Value>
          </QueryParameter>
        </QueryParameters>
        <Timeout>0</Timeout>
      </Query>
    </DataSet>
  </DataSets>
  <ReportParameters>
    <ReportParameter Name="anomes">
      <DataType>String</DataType>
      <Prompt>anomes</Prompt>
    </ReportParameter>
    <ReportParameter Name="codcliente">
      <DataType>String</DataType>
      <Prompt>codcliente</Prompt>
    </ReportParameter>
    <ReportParameter Name="codequip">
      <DataType>String</DataType>
      <Prompt>codequip</Prompt>
    </ReportParameter>
    <ReportParameter Name="codtipocausa">
      <DataType>String</DataType>
      <Prompt>codtipocausa</Prompt>
    </ReportParameter>
  </ReportParameters>
</Report>