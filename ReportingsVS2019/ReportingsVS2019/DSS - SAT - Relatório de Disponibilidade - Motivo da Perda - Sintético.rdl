<?xml version="1.0" encoding="utf-8"?>
<Report xmlns="http://schemas.microsoft.com/sqlserver/reporting/2008/01/reportdefinition" xmlns:rd="http://schemas.microsoft.com/SQLServer/reporting/reportdesigner">
  <Body>
    <ReportItems>
      <Tablix Name="matrix1">
        <TablixCorner>
          <TablixCornerRows>
            <TablixCornerRow>
              <TablixCornerCell>
                <CellContents>
                  <Textbox Name="textbox5">
                    <CanGrow>true</CanGrow>
                    <KeepTogether>true</KeepTogether>
                    <Paragraphs>
                      <Paragraph>
                        <TextRuns>
                          <TextRun>
                            <Value />
                            <Style>
                              <FontFamily>Tahoma</FontFamily>
                            </Style>
                          </TextRun>
                        </TextRuns>
                        <Style />
                      </Paragraph>
                    </Paragraphs>
                    <rd:DefaultName>textbox5</rd:DefaultName>
                    <Style>
                      <Border>
                        <Color>DimGray</Color>
                        <Style>Solid</Style>
                      </Border>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                  </Textbox>
                  <RowSpan>2</RowSpan>
                </CellContents>
              </TablixCornerCell>
            </TablixCornerRow>
            <TablixCornerRow>
              <TablixCornerCell />
            </TablixCornerRow>
          </TablixCornerRows>
        </TablixCorner>
        <TablixBody>
          <TablixColumns>
            <TablixColumn>
              <Width>0.83333in</Width>
            </TablixColumn>
            <TablixColumn>
              <Width>1.16667in</Width>
            </TablixColumn>
            <TablixColumn>
              <Width>1in</Width>
            </TablixColumn>
          </TablixColumns>
          <TablixRows>
            <TablixRow>
              <Height>0.21in</Height>
              <TablixCells>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="textbox2">
                      <CanGrow>true</CanGrow>
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>=Sum(Fields!Chamados.Value)</Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style>
                            <TextAlign>Center</TextAlign>
                          </Style>
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>textbox2</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>DimGray</Color>
                          <Style>Solid</Style>
                        </Border>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                  <DataElementOutput>Output</DataElementOutput>
                </TablixCell>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="textbox3">
                      <CanGrow>true</CanGrow>
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>=First(Fields!Indisponibilidade.Value)</Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style>
                            <TextAlign>Center</TextAlign>
                          </Style>
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>textbox3</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>DimGray</Color>
                          <Style>Solid</Style>
                        </Border>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                  <DataElementOutput>Output</DataElementOutput>
                </TablixCell>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="textbox4">
                      <CanGrow>true</CanGrow>
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>=First(Fields!TEMPO_MÉDIO.Value)</Value>
                              <Style>
                                <FontFamily>Tahoma</FontFamily>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style>
                            <TextAlign>Center</TextAlign>
                          </Style>
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>textbox4</rd:DefaultName>
                      <Style>
                        <Border>
                          <Color>DimGray</Color>
                          <Style>Solid</Style>
                        </Border>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                  <DataElementOutput>Output</DataElementOutput>
                </TablixCell>
              </TablixCells>
            </TablixRow>
          </TablixRows>
        </TablixBody>
        <TablixColumnHierarchy>
          <TablixMembers>
            <TablixMember>
              <Group Name="matrix1_Motivo">
                <GroupExpressions>
                  <GroupExpression>=Fields!Motivo.Value</GroupExpression>
                </GroupExpressions>
              </Group>
              <SortExpressions>
                <SortExpression>
                  <Value>=Fields!Motivo.Value</Value>
                </SortExpression>
              </SortExpressions>
              <TablixHeader>
                <Size>0.21in</Size>
                <CellContents>
                  <Textbox Name="Motivo">
                    <CanGrow>true</CanGrow>
                    <KeepTogether>true</KeepTogether>
                    <Paragraphs>
                      <Paragraph>
                        <TextRuns>
                          <TextRun>
                            <Value>=Fields!Motivo.Value</Value>
                            <Style>
                              <FontFamily>Tahoma</FontFamily>
                              <Color>White</Color>
                            </Style>
                          </TextRun>
                        </TextRuns>
                        <Style>
                          <TextAlign>Center</TextAlign>
                        </Style>
                      </Paragraph>
                    </Paragraphs>
                    <rd:DefaultName>Motivo</rd:DefaultName>
                    <Style>
                      <Border>
                        <Color>DimGray</Color>
                        <Style>Solid</Style>
                      </Border>
                      <BackgroundColor>#60759b</BackgroundColor>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                  </Textbox>
                </CellContents>
              </TablixHeader>
              <TablixMembers>
                <TablixMember>
                  <TablixHeader>
                    <Size>0.21in</Size>
                    <CellContents>
                      <Textbox Name="textbox6">
                        <CanGrow>true</CanGrow>
                        <KeepTogether>true</KeepTogether>
                        <Paragraphs>
                          <Paragraph>
                            <TextRuns>
                              <TextRun>
                                <Value>Chamados</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                </Style>
                              </TextRun>
                            </TextRuns>
                            <Style>
                              <TextAlign>Center</TextAlign>
                            </Style>
                          </Paragraph>
                        </Paragraphs>
                        <rd:DefaultName>textbox6</rd:DefaultName>
                        <Style>
                          <Border>
                            <Color>DimGray</Color>
                            <Style>Solid</Style>
                          </Border>
                          <BackgroundColor>LightSteelBlue</BackgroundColor>
                          <PaddingLeft>2pt</PaddingLeft>
                          <PaddingRight>2pt</PaddingRight>
                          <PaddingTop>2pt</PaddingTop>
                          <PaddingBottom>2pt</PaddingBottom>
                        </Style>
                      </Textbox>
                    </CellContents>
                  </TablixHeader>
                  <KeepTogether>true</KeepTogether>
                </TablixMember>
                <TablixMember>
                  <TablixHeader>
                    <Size>0.21in</Size>
                    <CellContents>
                      <Textbox Name="textbox7">
                        <CanGrow>true</CanGrow>
                        <KeepTogether>true</KeepTogether>
                        <Paragraphs>
                          <Paragraph>
                            <TextRuns>
                              <TextRun>
                                <Value>Indisponibilidade</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                </Style>
                              </TextRun>
                            </TextRuns>
                            <Style>
                              <TextAlign>Center</TextAlign>
                            </Style>
                          </Paragraph>
                        </Paragraphs>
                        <rd:DefaultName>textbox7</rd:DefaultName>
                        <Style>
                          <Border>
                            <Color>DimGray</Color>
                            <Style>Solid</Style>
                          </Border>
                          <BackgroundColor>LightSteelBlue</BackgroundColor>
                          <PaddingLeft>2pt</PaddingLeft>
                          <PaddingRight>2pt</PaddingRight>
                          <PaddingTop>2pt</PaddingTop>
                          <PaddingBottom>2pt</PaddingBottom>
                        </Style>
                      </Textbox>
                    </CellContents>
                  </TablixHeader>
                  <KeepTogether>true</KeepTogether>
                </TablixMember>
                <TablixMember>
                  <TablixHeader>
                    <Size>0.21in</Size>
                    <CellContents>
                      <Textbox Name="textbox8">
                        <CanGrow>true</CanGrow>
                        <KeepTogether>true</KeepTogether>
                        <Paragraphs>
                          <Paragraph>
                            <TextRuns>
                              <TextRun>
                                <Value>TEMPO MÉDIO</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                </Style>
                              </TextRun>
                            </TextRuns>
                            <Style>
                              <TextAlign>Center</TextAlign>
                            </Style>
                          </Paragraph>
                        </Paragraphs>
                        <rd:DefaultName>textbox8</rd:DefaultName>
                        <Style>
                          <Border>
                            <Color>DimGray</Color>
                            <Style>Solid</Style>
                          </Border>
                          <BackgroundColor>LightSteelBlue</BackgroundColor>
                          <PaddingLeft>2pt</PaddingLeft>
                          <PaddingRight>2pt</PaddingRight>
                          <PaddingTop>2pt</PaddingTop>
                          <PaddingBottom>2pt</PaddingBottom>
                        </Style>
                      </Textbox>
                    </CellContents>
                  </TablixHeader>
                  <KeepTogether>true</KeepTogether>
                </TablixMember>
              </TablixMembers>
              <DataElementOutput>Output</DataElementOutput>
              <KeepTogether>true</KeepTogether>
            </TablixMember>
          </TablixMembers>
        </TablixColumnHierarchy>
        <TablixRowHierarchy>
          <TablixMembers>
            <TablixMember>
              <Group Name="matrix1_FILIAL">
                <GroupExpressions>
                  <GroupExpression>=Fields!FILIAL.Value</GroupExpression>
                </GroupExpressions>
              </Group>
              <SortExpressions>
                <SortExpression>
                  <Value>=Fields!FILIAL.Value</Value>
                </SortExpression>
              </SortExpressions>
              <TablixHeader>
                <Size>0.78125in</Size>
                <CellContents>
                  <Textbox Name="FILIAL">
                    <CanGrow>true</CanGrow>
                    <KeepTogether>true</KeepTogether>
                    <Paragraphs>
                      <Paragraph>
                        <TextRuns>
                          <TextRun>
                            <Value>=Fields!FILIAL.Value</Value>
                            <Style>
                              <FontFamily>Tahoma</FontFamily>
                              <Color>White</Color>
                            </Style>
                          </TextRun>
                        </TextRuns>
                        <Style>
                          <TextAlign>Center</TextAlign>
                        </Style>
                      </Paragraph>
                    </Paragraphs>
                    <rd:DefaultName>FILIAL</rd:DefaultName>
                    <Style>
                      <Border>
                        <Color>DimGray</Color>
                        <Style>Solid</Style>
                      </Border>
                      <BackgroundColor>#60759b</BackgroundColor>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                  </Textbox>
                </CellContents>
              </TablixHeader>
              <DataElementOutput>Output</DataElementOutput>
              <KeepTogether>true</KeepTogether>
            </TablixMember>
          </TablixMembers>
        </TablixRowHierarchy>
        <RepeatColumnHeaders>true</RepeatColumnHeaders>
        <RepeatRowHeaders>true</RepeatRowHeaders>
        <DataSetName>DataSet1</DataSetName>
        <Height>0.63in</Height>
        <Width>3.78125in</Width>
        <Style />
      </Tablix>
    </ReportItems>
    <Height>0.63in</Height>
    <Style />
  </Body>
  <Width>3.78125in</Width>
  <Page>
    <LeftMargin>1in</LeftMargin>
    <RightMargin>1in</RightMargin>
    <TopMargin>1in</TopMargin>
    <BottomMargin>1in</BottomMargin>
    <Style />
  </Page>
  <AutoRefresh>0</AutoRefresh>
  <DataSources>
    <DataSource Name="SAT">
      <DataSourceReference>SAT</DataSourceReference>
      <rd:SecurityType>None</rd:SecurityType>
      <rd:DataSourceID>47e7819b-926e-4c13-80b8-59680b31a44a</rd:DataSourceID>
    </DataSource>
  </DataSources>
  <DataSets>
    <DataSet Name="DataSet1">
      <Query>
        <DataSourceName>SAT</DataSourceName>
        <QueryParameters>
          <QueryParameter Name="@ANO">
            <Value>=Parameters!ANO.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@MES">
            <Value>=Parameters!MES.Value</Value>
          </QueryParameter>
        </QueryParameters>
        <CommandText>DECLARE			@DataFiltro1 DATETIME
DECLARE			@DataFiltro2 DATETIME
DECLARE			@AnoMes varchar(6)

SET				@AnoMes = CAST(@ANO AS VARCHAR) +CAST(DBO.INSERTZERO(@MES,2) AS VARCHAR)

SET				@DataFiltro1 = CAST((@ANO + '-' +  @MES + '-' + '01') AS DATETIME)
SET				@DataFiltro2 = CAST(((CASE @MES WHEN 12 THEN CAST((@ANO + 1) AS VARCHAR) ELSE @ANO END) + '-' + (CASE @MES WHEN 12 THEN '01' ELSE DBO.INSERTZERO((@MES + 1),2) END) + '-' + '01') AS DATETIME)

SELECT			FILIAL, 
				CASE Motivo 
					WHEN 'OPERACIONAL' THEN 'Chamados perdidos por operacional sem peça'
					WHEN 'OPERACIONAL COM PEÇA' THEN 'Chamados perdidos por operacional com peça'
					WHEN 'FALTANTE' THEN 'Chamados perdidos por peça faltante'
					WHEN 'PEND. FILIAL' THEN 'Chamados perdidos por peça pendente'
					ELSE ''
				END AS Motivo, 
				COUNT(*) AS Chamados,
				dbo.FN_CONVMIN(	SUM(Indisponibilidade)) AS Indisponibilidade,
				dbo.FN_CONVMIN(	SUM(Indisponibilidade)/COUNT(*)) AS 'TEMPO MÉDIO'
FROM			(
					SELECT			DADOS.*,
									--dbo.FN_CONVMIN(	
										CASE WHEN OS.CodStatusServico = 2
											THEN 0
											ELSE
														CASE WHEN dbo.fc_CalcMinutosIndisponibilidade(dateadd(dd,dc.QTDDias,
															CASE WHEN (
																		SELECT dbo.fc_DispBBRetornaProximoDiaUtil(Dados.DataFiltro, ec.CodSLA, ci.codUf, ci.CodCidade,ec.IndSEMAT)
																	) &lt; @DataFiltro1									
																	THEN (CONVERT(VARCHAR, @DataFiltro1, 111) + ' ' + CONVERT(VARCHAR(5), dc.HorarioInicio, 108))
																	ELSE (SELECT dbo.fc_DispBBRetornaProximoDiaUtil(Dados.DataFiltro, ec.CodSLA, ci.codUf, ci.CodCidade, ec.IndSEMAT))
															END
															), 
															CASE WHEN	isnull((SELECT TOP 1 DataHoraSolucao FROM RAT WHERE RAT.CodOS = os.CodOS AND RAT.CodStatusServico = 3 ORDER BY 1 DESC), getdate()) 
																		&gt; 
																		(Select CAST((CAST(CAST(DateAdd(mm, DateDiff(mm,0,(CAST(@ANO + '-' + @MES + '-01'  AS datetime))), 30) AS DATE) AS VARCHAR) + ' 23:59:59') AS DATETIME))
																THEN (Select CAST((CAST(CAST(DateAdd(mm, DateDiff(mm,0,(CAST(@ANO + '-' + @MES + '-01'  AS datetime))), 30) AS DATE) AS VARCHAR) + ' 23:59:59') AS DATETIME))
																ELSE isnull((SELECT TOP 1 DataHoraSolucao FROM RAT WHERE RAT.CodOS = os.CodOS AND RAT.CodStatusServico = 3 ORDER BY 1 DESC), getdate())
															END
															, dc.HorarioInicio, dc.HorarioFim, dc.indSab, dc.indDom, dc.indFeriado, 1, ci.codUf, ci.CodCidade
															,(isnull((SELECT TOP	1 1 
																FROM	 RATDetalhes 
																inner join OS OSR on RATDetalhes.CodOS = OSR.CodOS
																WHERE	 OSR.CodOS = OS.CodOS 
																AND	 CodCausa IN (SELECT CodCausa 
																					FROM	 Causa 
																					WHERE	 CodECausa LIKE '02%' 
																					OR	 CodECausa LIKE '08%'
																					AND		CodECausa NOT IN ('08300','08310','08320')
																					)
																AND   OSR.CodStatusServico NOT IN (2,3)
																), 0))) &lt; 0
														THEN 0
														ELSE dbo.fc_CalcMinutosIndisponibilidade(dateadd(dd,dc.QTDDias,
															CASE WHEN (
																		SELECT dbo.fc_DispBBRetornaProximoDiaUtil(Dados.DataFiltro, ec.CodSLA, ci.codUf, ci.CodCidade,ec.IndSEMAT)
																	) &lt; @DataFiltro1									
																	THEN (CONVERT(VARCHAR, @DataFiltro1, 111) + ' ' + CONVERT(VARCHAR(5), dc.HorarioInicio, 108))
																	ELSE (SELECT dbo.fc_DispBBRetornaProximoDiaUtil(Dados.DataFiltro, ec.CodSLA, ci.codUf, ci.CodCidade, ec.IndSEMAT))
															END
															), 
															CASE WHEN	isnull((SELECT TOP 1 DataHoraSolucao FROM RAT WHERE RAT.CodOS = os.CodOS AND RAT.CodStatusServico = 3 ORDER BY 1 DESC), getdate()) 
																		&gt; 
																		(Select CAST((CAST(CAST(DateAdd(mm, DateDiff(mm,0,(CAST(@ANO + '-' + @MES + '-01'  AS datetime))), 30) AS DATE) AS VARCHAR) + ' 23:59:59') AS DATETIME))
																THEN (Select CAST((CAST(CAST(DateAdd(mm, DateDiff(mm,0,(CAST(@ANO + '-' + @MES + '-01'  AS datetime))), 30) AS DATE) AS VARCHAR) + ' 23:59:59') AS DATETIME))
																ELSE isnull((SELECT TOP 1 DataHoraSolucao FROM RAT WHERE RAT.CodOS = os.CodOS AND RAT.CodStatusServico = 3 ORDER BY 1 DESC), getdate())
															END
															, dc.HorarioInicio, dc.HorarioFim, dc.indSab, dc.indDom, dc.indFeriado, 1, ci.codUf, ci.CodCidade
															, (isnull((SELECT TOP	1 1 
																FROM	 RATDetalhes 
																inner join OS OSR on RATDetalhes.CodOS = OSR.CodOS
																WHERE	 OSR.CodOS = OS.CodOS 
																AND	 CodCausa IN (SELECT CodCausa 
																					FROM	 Causa 
																					WHERE	 CodECausa LIKE '02%' 
																					OR	 CodECausa LIKE '08%'
																					AND		CodECausa NOT IN ('08300','08310','08320')
																					)
																AND   OSR.CodStatusServico IN (2,3)
																), 0)	)) 
													END 
									END
									--) 
									Indisponibilidade
					FROM			(
											SELECT			OS.NumOSCliente, OS.CodOS AS OS, Cliente.NumBanco, 
															CASE WHEN OS.CodCliente = 1
																	THEN (CASE WHEN EquipamentoContrato.IndGarantia = 1
																				THEN 'BB'
																				ELSE 'COBRA'
																		  END)
																	ELSE
																			Cliente.NomeFantasia
															END AS Cliente, 
															Contrato.NroContrato, Contrato.NomeContrato, 
															TipoIntervencao.NomTipoIntervencao AS Intervencao, Filial.NomeFilial AS Filial,		
															CASE WHEN IndSEMAT = 1
																THEN 'SIM'
																ELSE 'NAO'
															END AS SEMAT,
															DataHoraAberturaOS,				
															(SELECT TOP 1 CONVERT(VARCHAR, AOS.DataAgendamento, 120) FROM AgendamentoOS AOS WHERE AOS.CodOS = OS.CodOS ORDER BY AOS.CodAgendamento ASC) AS DataAgendamento,
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT TOP 1 CONVERT(VARCHAR, ISNULL(DataHoraSolucaoValida, DataHoraSolucao), 120) FROM RAT WHERE RAT.codos = OS.CodOS ORDER BY CodRAT DESC)
																ELSE
																	NULL
															END AS DataFechamento,
															CONVERT(VARCHAR, OS.DataHoraFechamento, 120) AS DataFechamentoSAT,
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT CONVERT(VARCHAR, DataHoraLimiteAtendimento, 120) FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	(SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS)
															END AS DataFimSLA,
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT StatusSLAOS FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																		THEN 'FORA'
																		ELSE 'DENTRO'
																	END
															END AS StatusSLA,
															SLA.NomeSLA AS SLA, StatusServico.NomeStatusServico AS StatusOS, 
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT KMDistancia FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	(SELECT SUBSTRING(dbo.fc_PrazoAtendimentoSLA(OS.CodOS), 23, 5))
															END AS KM,				
															dbo.insertZero(CAST(ISNULL(dbo.fc_CalcDistanciaAdicionalKM(
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT KMDistancia FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	(SELECT SUBSTRING(dbo.fc_PrazoAtendimentoSLA(OS.CodOS), 23, 5))
															END, 85, 65, 60), 0) AS INT) / 60, 2) + ':' +
															dbo.insertZero(CAST(ISNULL(dbo.fc_CalcDistanciaAdicionalKM(
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT KMDistancia FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	(SELECT SUBSTRING(dbo.fc_PrazoAtendimentoSLA(OS.CodOS), 23, 5))
															END, 85, 65, 60), 0) AS INT) % 60, 2
															) AS QtdHorasAcrescimoKM,
															Regiao.NomeRegiao AS Regiao, LocalAtendimento.NumAgencia + '/' + LocalAtendimento.DCPosto AS Agencia, 
															LocalAtendimento.NomeLocal AS _Local, Cidade.NomeCidade AS Cidade, UF.SiglaUF AS UF, e.NomeEquip AS Equipamento, 
															EquipamentoContrato.NumSerie AS NSerie, OS.NumOSQuarteirizada, 
															OS.DefeitoRelatado, OS.ObservacaoCliente AS Observacao, 
															RegiaoAutorizada.PA,				
															(SELECT TOP 1 NumRAT FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC) AS RAT,
															(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad ASC) AS InicioAtendimento,
															(SELECT TOP 1 RelatoSolucao  FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC) AS RelatoSolucao,
															(
																	CASE WHEN 	(
																					SELECT      COUNT(*)
																					FROM        RAT
																					WHERE		RAT.CodRAT IN ( 
																												SELECT		CodRAT
																												FROM		RATDetalhes AS RATDE
																												WHERE		(
																															 RATDE.CodDefeito IN (64,77,79,81,86,91,94,95)
																															 OR			
																															 RATDE.CodAcao IN (5,14,15,16,18,23,24)
																															 OR
																															 RATDE.CodCausa IN (1,7,15,41,69,73,82,241,365,416,427,445,451,459,485,513,517,526,688,820,869,879)
																															)	
																											   )
																					AND			RAT.CodOS = OS.CodOS
																				) &gt; 0

																			THEN ''
																			ELSE 'MQ'
																	END
															) AS MQ,
															(
																	CASE WHEN 	(
																					SELECT      COUNT(*)
																					FROM        RAT
																					WHERE		RAT.CodRAT IN ( 
																												SELECT		CodRAT
																												FROM		RATDetalhes AS RATDE
																												WHERE		(
																															 RATDE.CodDefeito IN (64,77,79,81,86,91,94,95)
																															 OR			
																															 RATDE.CodAcao IN (5,14,15,16,18,23,24)
																															 OR
																															 RATDE.CodCausa IN (1,7,15,41,69,73,82,241,365,416,427,445,451,459,485,513,517,526,688,820,869,879)
																															)	
																											   )
																					AND			RAT.CodOS = OS.CodOS
																				) &gt; 0

																			THEN 'EM'
																			ELSE ''
																	END				
															) AS EM,			
															(
																SELECT			TOP 1 TipoCausa.NomeTipoCausa
																FROM			RATDetalhes 
																INNER JOIN		TipoCausa ON RATDetalhes.CodTipoCausa = TipoCausa.CodTipoCausa
																WHERE			RATDetalhes.CodRAT = (SELECT TOP 1 CodRAT FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC)
																ORDER BY		RATDetalhes.CODRATDetalhe DESC
															) AS CAUSA,
															CASE OS.CodStatusServico 
																WHEN 3 THEN
																	(CASE WHEN (SELECT StatusSLAOS FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) = 'DENTRO'
																		THEN 'NO PRAZO'
																		ELSE 
																			(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) &lt; (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad))
																				THEN 'VENCIDO'
																				ELSE 'NO PRAZO'
																				END)
																		END)
																ELSE
																(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																		THEN	
																			(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad))
																					THEN 'VENCIDO'
																					ELSE 'NO PRAZO'
																					END)
																		ELSE 
																			'NO PRAZO'								
																		END)
																		END				as 'Tempo Resposta',
															(CASE OS.CodStatusServico 
																WHEN 3 THEN
																	CASE WHEN (SELECT TOP 1 DataHoraSolucao FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad desc) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																		THEN '-'
																		ELSE REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS),(SELECT TOP 1 DataHoraSolucao FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad desc))) ),'-','')						
																		END
																ELSE
																	CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																	THEN	
																		(CASE WHEN
																			(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																			THEN 
																				(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																					THEN 
																					(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																						THEN
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																							THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																									THEN 															
																										REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS),GETDATE()))),'-','')
																									ELSE
																										(CASE WHEN
																											(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 	
																											THEN 
																												REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC),(SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS)))),'-','')
																											ELSE 
																												REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC),
																																	(SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS)))),'-','')															
																										END)
															
																									END)
																							ELSE 
																								REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC),(SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS)))),'-','')													
																							END)
																					END)											
																				ELSE		
																				(CASE WHEN
																						(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																							THEN REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS),GETDATE()))),'-','')
																							ELSE 								
																								REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS),GETDATE()))),'-','')
																					END)
																				END)									
																			ELSE									
																				REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS),GETDATE()))),'-','')
													
																		END)

																	ELSE	
																		'-'
																	END
																END
																) as Atraso,					
															(SELECT Nome FROM Tecnico where CodTecnico = (SELECT TOP 1 CodTecnico FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC)) as Tecnico,
															(CASE OS.CodStatusServico 
																WHEN 3 THEN
																	(CASE WHEN (SELECT StatusSLAOS FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) = 'DENTRO'
																		THEN '-'
																		ELSE 
																			(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) &lt; GETDATE())
																				THEN	
																					(CASE WHEN
																						(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 
																						THEN 
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																								THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 
																									THEN
																										(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													'FALTANTE'
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															'OPERACIONAL' 																				
																														ELSE
																															'FALTANTE'
																													END)
																		
																												END)
																										ELSE 
																											'PEND. FILIAL'													
																										END)
																										ELSE 
																										(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0
																											THEN (CASE WHEN (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) = (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 10 ORDER BY DataHoraCad)
																															THEN 'FALTANTE'
																															ELSE 'PEND. FILIAL'
																															END)
																											ELSE 'PEND. FILIAL'
																											END)
																								END)											
																							ELSE
																								(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													'FALTANTE'
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	'OPERACIONAL COM PEÇA'
																																ELSE
																																	'OPERACIONAL' 																				
																															END)																				
																														ELSE
																															'FALTANTE'
																													END)
																		
																												END)
																										ELSE 
																											(CASE WHEN
																												(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																												THEN 
																													'OPERACIONAL COM PEÇA'
																												ELSE
																													'OPERACIONAL' 																				
																											END)											
																										END)
																							END)									
																						ELSE 
																							(CASE WHEN
																								(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																								THEN 
																									'OPERACIONAL COM PEÇA'
																								ELSE
																									'OPERACIONAL' 																				
																							END)
																					END)

																				ELSE	
																					'-'
																				END)									
																			END)
																ELSE
																	CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																	THEN	
																		(CASE WHEN
																			(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																			THEN 
																				(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																					THEN 
																					(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																						THEN
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																							THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																									THEN 
																										'FALTANTE'
																									ELSE
																										(CASE WHEN
																											(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 	
																											THEN 
																												(CASE WHEN
																													(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																													THEN 
																														'OPERACIONAL COM PEÇA'
																													ELSE
																														'OPERACIONAL' 																				
																												END)
																											ELSE 
																												'FALTANTE'
																										END)
															
																									END)
																							ELSE 
																								'PEND. FILIAL'													
																							END)
																							ELSE 
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0
																											THEN (CASE WHEN (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) = (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 10 ORDER BY DataHoraCad)
																															THEN 'FALTANTE'
																															ELSE 'PEND. FILIAL' 
																															END)
																											ELSE 'PEND. FILIAL'
																											END)
																					END)											
																				ELSE
																					(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													'FALTANTE'
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	'OPERACIONAL COM PEÇA'
																																ELSE
																																	'OPERACIONAL' 																				
																															END)																				
																														ELSE
																															'FALTANTE'
																													END)
																		
																												END)
																										ELSE 
																											(CASE WHEN (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																													THEN	
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	'OPERACIONAL COM PEÇA'
																																ELSE
																																	'OPERACIONAL' 																				
																															END)
																													ELSE	
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	'OPERACIONAL COM PEÇA'
																																ELSE
																																	'OPERACIONAL' 																				
																															END)
																											END)
																										END)
																				END)									
																			ELSE 
																				(CASE WHEN
																					(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																					THEN 
																						'OPERACIONAL COM PEÇA'
																					ELSE
																						'OPERACIONAL' 																				
																				END)
																		END)

																	ELSE	
																		'-'
																	END
																END
															) as Motivo,
															(CASE OS.CodStatusServico 
																WHEN 3 THEN
																	(CASE WHEN (SELECT StatusSLAOS FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) = 'DENTRO'
																		THEN 
																				--'-'
																				OS.DataHoraAberturaOS
																		ELSE 
																			(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) &lt; GETDATE())
																				THEN	
																					(CASE WHEN
																						(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 
																						THEN 
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																								THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 
																									THEN
																										(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													--'FALTANTE'
																													ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															--'OPERACIONAL' 			
																															OS.DataHoraAberturaOS																	
																														ELSE
																															--'FALTANTE'
																															ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																													END)
																		
																												END)
																										ELSE 
																											--'PEND. FILIAL'	
																											ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)												
																										END)
																										ELSE 
																										(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0
																											THEN (CASE WHEN (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) = (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 10 ORDER BY DataHoraCad)
																															THEN --'FALTANTE'
																																ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																															ELSE --'PEND. FILIAL'
																																ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)
																															END)
																											ELSE --'PEND. FILIAL'
																												 ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)	
																											END)
																								END)											
																							ELSE
																								(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													--'FALTANTE'
																													ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	--'OPERACIONAL COM PEÇA'
																																	OS.DataHoraAberturaOS
																																ELSE
																																	--'OPERACIONAL' 																				
																																	OS.DataHoraAberturaOS
																															END)																				
																														ELSE
																															--'FALTANTE'
																															ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																													END)
																		
																												END)
																										ELSE 
																											(CASE WHEN
																												(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																												THEN 
																													--'OPERACIONAL COM PEÇA'
																													OS.DataHoraAberturaOS
																												ELSE
																													--'OPERACIONAL' 						
																													OS.DataHoraAberturaOS														
																											END)											
																										END)
																							END)									
																						ELSE 
																							(CASE WHEN
																								(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																								THEN 
																									--'OPERACIONAL COM PEÇA'
																									OS.DataHoraAberturaOS
																								ELSE
																									--'OPERACIONAL' 																				
																									OS.DataHoraAberturaOS
																							END)
																					END)

																				ELSE	
																					--'-'
																					OS.DataHoraAberturaOS
																				END)									
																			END)
																ELSE
																	CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																	THEN	
																		(CASE WHEN
																			(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																			THEN 
																				(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																					THEN 
																					(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																						THEN
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																							THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																									THEN 
																										--'FALTANTE'
																										ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																									ELSE
																										(CASE WHEN
																											(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 	
																											THEN 
																												(CASE WHEN
																													(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																													THEN 
																														--'OPERACIONAL COM PEÇA'
																														OS.DataHoraAberturaOS
																													ELSE
																														--'OPERACIONAL' 																				
																														OS.DataHoraAberturaOS
																												END)
																											ELSE 
																												--'FALTANTE'
																												ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																										END)
															
																									END)
																							ELSE 
																								--'PEND. FILIAL'													
																								ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)
																							END)
																							ELSE 
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0
																											THEN (CASE WHEN (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) = (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 10 ORDER BY DataHoraCad)
																															THEN	--'FALTANTE'
																																	ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																															ELSE	--'PEND. FILIAL' 
																																	ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)
																															END)
																											ELSE 
																													--'PEND. FILIAL'
																													ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)
																											END)
																					END)											
																				ELSE
																					(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																														--'FALTANTE'
																														ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	--'OPERACIONAL COM PEÇA'
																																	OS.DataHoraAberturaOS
																																ELSE
																																	--'OPERACIONAL' 																				
																																	OS.DataHoraAberturaOS
																															END)																				
																														ELSE
																															--'FALTANTE'
																															ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																													END)
																		
																												END)
																										ELSE 
																											(CASE WHEN (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																													THEN	
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	--'OPERACIONAL COM PEÇA'
																																	OS.DataHoraAberturaOS
																																ELSE
																																	--'OPERACIONAL' 																				
																																	OS.DataHoraAberturaOS
																															END)
																													ELSE	
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	--'OPERACIONAL COM PEÇA'
																																	OS.DataHoraAberturaOS
																																ELSE
																																	--'OPERACIONAL' 																				
																																	OS.DataHoraAberturaOS
																															END)
																											END)
																										END)
																				END)									
																			ELSE 
																				(CASE WHEN
																					(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																					THEN 
																						--'OPERACIONAL COM PEÇA'
																						OS.DataHoraAberturaOS
																					ELSE
																						--'OPERACIONAL' 																				
																						OS.DataHoraAberturaOS
																				END)
																		END)

																	ELSE	
																		--'-'
																		OS.DataHoraAberturaOS
																	END
																END
																) as DataFiltro
											FROM			DispBBCalcOS
											INNER JOIN		OS ON DispBBCalcOS.CodOS = OS.CodOS
											INNER JOIN		DispBBEquipamentoContrato EquipamentoContrato ON os.CodEquipContrato = EquipamentoContrato.CodEquipContrato
											INNER JOIN		Contrato ON Contrato.CodContrato = EquipamentoContrato.CodContrato
											INNER JOIN		Cliente ON OS.CodCliente = Cliente.CodCliente
											INNER JOIN		Equipamento e ON e.CodEquip = EquipamentoContrato.CodEquip
											INNER JOIN		LocalAtendimento ON LocalAtendimento.CodPosto = EquipamentoContrato.CodPosto
											INNER JOIN		Filial ON EquipamentoContrato.CodFilial = Filial.CodFilial
											INNER JOIN		Cidade on LocalAtendimento.CodCidade = Cidade.CodCidade
											INNER JOIN		UF ON UF.CodUF = Cidade.CodUF
											INNER JOIN		DispBBCriticidade dc ON EquipamentoContrato.CodSLA = dc.CodSLA
											INNER JOIN		DispBBRegiaoUF duf ON UF.CodUF = duf.CodUF
											INNER JOIN		DispBBRegiao dr ON duf.CodDispBBRegiao = dr.CodDispBBRegiao
											INNER JOIN		TipoIntervencao ON OS.CodTipoIntervencao = TipoIntervencao.CodTipoIntervencao
											INNER JOIN		StatusServico ON OS.CodStatusServico = StatusServico.CodStatusServico
											LEFT OUTER JOIN Autorizada ON OS.CodAutorizada = Autorizada.CodAutorizada
											LEFT OUTER JOIN Regiao ON OS.CodRegiao = Regiao.CodRegiao
											LEFT OUTER JOIN SLA ON EquipamentoContrato.CodSLA = SLA.CodSLA
											INNER JOIN		RegiaoAutorizada ON EquipamentoContrato.CodRegiao = RegiaoAutorizada.CodRegiao AND EquipamentoContrato.CodAutorizada = RegiaoAutorizada.CodAutorizada 
															AND RegiaoAutorizada.CodFilial NOT in (7, 21) 
											WHERE			DispBBCalcOS.AnoMes = @AnoMes
											AND				EquipamentoContrato.AnoMes = @AnoMes
										) AS DADOS
					INNER JOIN			OS ON DADOS.OS = OS.CodOS
					INNER JOIN			DispBBCalcOS ON OS.CodOS = DispBBCalcOS.CodOS
					INNER JOIN			DispBBEquipamentoContrato ec ON os.CodEquipContrato = ec.CodEquipContrato
					INNER JOIN			LocalAtendimento lc ON lc.CodPosto = ec.CodPosto
					INNER JOIN			Cidade ci on lc.CodCidade = ci.CodCidade
					INNER JOIN			UF ON UF.CodUF = ci.CodUF
					INNER JOIN			DispBBCriticidade dc ON ec.CodSLA = dc.CodSLA
					WHERE				DispBBCalcOS.AnoMes = @AnoMes
					AND					EC.AnoMes = @AnoMes
				) AS SINTETICO
WHERE			Motivo &lt;&gt; '-'
GROUP BY		FILIAL, Motivo

UNION

SELECT			FILIAL, 
				'TOTAL' AS Motivo, 
				COUNT(*) AS Chamados,
				dbo.FN_CONVMIN(	SUM(Indisponibilidade)) AS Indisponibilidade,
				dbo.FN_CONVMIN(	SUM(Indisponibilidade)/COUNT(*)) AS 'TEMPO MÉDIO'
FROM			(
					SELECT			DADOS.*,
									--dbo.FN_CONVMIN(	
										CASE WHEN OS.CodStatusServico = 2
											THEN 0
											ELSE
														CASE WHEN dbo.fc_CalcMinutosIndisponibilidade(dateadd(dd,dc.QTDDias,
															CASE WHEN (
																		SELECT dbo.fc_DispBBRetornaProximoDiaUtil(Dados.DataFiltro, ec.CodSLA, ci.codUf, ci.CodCidade,ec.IndSEMAT)
																	) &lt; @DataFiltro1									
																	THEN (CONVERT(VARCHAR, @DataFiltro1, 111) + ' ' + CONVERT(VARCHAR(5), dc.HorarioInicio, 108))
																	ELSE (SELECT dbo.fc_DispBBRetornaProximoDiaUtil(Dados.DataFiltro, ec.CodSLA, ci.codUf, ci.CodCidade, ec.IndSEMAT))
															END
															), 
															CASE WHEN	isnull((SELECT TOP 1 DataHoraSolucao FROM RAT WHERE RAT.CodOS = os.CodOS AND RAT.CodStatusServico = 3 ORDER BY 1 DESC), getdate()) 
																		&gt; 
																		(Select CAST((CAST(CAST(DateAdd(mm, DateDiff(mm,0,(CAST(@ANO + '-' + @MES + '-01'  AS datetime))), 30) AS DATE) AS VARCHAR) + ' 23:59:59') AS DATETIME))
																THEN (Select CAST((CAST(CAST(DateAdd(mm, DateDiff(mm,0,(CAST(@ANO + '-' + @MES + '-01'  AS datetime))), 30) AS DATE) AS VARCHAR) + ' 23:59:59') AS DATETIME))
																ELSE isnull((SELECT TOP 1 DataHoraSolucao FROM RAT WHERE RAT.CodOS = os.CodOS AND RAT.CodStatusServico = 3 ORDER BY 1 DESC), getdate())
															END
															, dc.HorarioInicio, dc.HorarioFim, dc.indSab, dc.indDom, dc.indFeriado, 1, ci.codUf, ci.CodCidade
															,(isnull((SELECT TOP	1 1 
																FROM	 RATDetalhes 
																inner join OS OSR on RATDetalhes.CodOS = OSR.CodOS
																WHERE	 OSR.CodOS = OS.CodOS 
																AND	 CodCausa IN (SELECT CodCausa 
																					FROM	 Causa 
																					WHERE	 CodECausa LIKE '02%' 
																					OR	 CodECausa LIKE '08%'
																					AND		CodECausa NOT IN ('08300','08310','08320')
																					)
																AND   OSR.CodStatusServico NOT IN (2,3)
																), 0))) &lt; 0
														THEN 0
														ELSE dbo.fc_CalcMinutosIndisponibilidade(dateadd(dd,dc.QTDDias,
															CASE WHEN (
																		SELECT dbo.fc_DispBBRetornaProximoDiaUtil(Dados.DataFiltro, ec.CodSLA, ci.codUf, ci.CodCidade,ec.IndSEMAT)
																	) &lt; @DataFiltro1									
																	THEN (CONVERT(VARCHAR, @DataFiltro1, 111) + ' ' + CONVERT(VARCHAR(5), dc.HorarioInicio, 108))
																	ELSE (SELECT dbo.fc_DispBBRetornaProximoDiaUtil(Dados.DataFiltro, ec.CodSLA, ci.codUf, ci.CodCidade, ec.IndSEMAT))
															END
															), 
															CASE WHEN	isnull((SELECT TOP 1 DataHoraSolucao FROM RAT WHERE RAT.CodOS = os.CodOS AND RAT.CodStatusServico = 3 ORDER BY 1 DESC), getdate()) 
																		&gt; 
																		(Select CAST((CAST(CAST(DateAdd(mm, DateDiff(mm,0,(CAST(@ANO + '-' + @MES + '-01'  AS datetime))), 30) AS DATE) AS VARCHAR) + ' 23:59:59') AS DATETIME))
																THEN (Select CAST((CAST(CAST(DateAdd(mm, DateDiff(mm,0,(CAST(@ANO + '-' + @MES + '-01'  AS datetime))), 30) AS DATE) AS VARCHAR) + ' 23:59:59') AS DATETIME))
																ELSE isnull((SELECT TOP 1 DataHoraSolucao FROM RAT WHERE RAT.CodOS = os.CodOS AND RAT.CodStatusServico = 3 ORDER BY 1 DESC), getdate())
															END
															, dc.HorarioInicio, dc.HorarioFim, dc.indSab, dc.indDom, dc.indFeriado, 1, ci.codUf, ci.CodCidade
															, (isnull((SELECT TOP	1 1 
																FROM	 RATDetalhes 
																inner join OS OSR on RATDetalhes.CodOS = OSR.CodOS
																WHERE	 OSR.CodOS = OS.CodOS 
																AND	 CodCausa IN (SELECT CodCausa 
																					FROM	 Causa 
																					WHERE	 CodECausa LIKE '02%' 
																					OR	 CodECausa LIKE '08%'
																					AND		CodECausa NOT IN ('08300','08310','08320')
																					)
																AND   OSR.CodStatusServico IN (2,3)
																), 0)	)) 
													END 
									END
									--) 
									Indisponibilidade
					FROM			(
											SELECT			OS.NumOSCliente, OS.CodOS AS OS, Cliente.NumBanco, 
															CASE WHEN OS.CodCliente = 1
																	THEN (CASE WHEN EquipamentoContrato.IndGarantia = 1
																				THEN 'BB'
																				ELSE 'COBRA'
																		  END)
																	ELSE
																			Cliente.NomeFantasia
															END AS Cliente, 
															Contrato.NroContrato, Contrato.NomeContrato, 
															TipoIntervencao.NomTipoIntervencao AS Intervencao, Filial.NomeFilial AS Filial,		
															CASE WHEN IndSEMAT = 1
																THEN 'SIM'
																ELSE 'NAO'
															END AS SEMAT,
															DataHoraAberturaOS,				
															(SELECT TOP 1 CONVERT(VARCHAR, AOS.DataAgendamento, 120) FROM AgendamentoOS AOS WHERE AOS.CodOS = OS.CodOS ORDER BY AOS.CodAgendamento ASC) AS DataAgendamento,
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT TOP 1 CONVERT(VARCHAR, ISNULL(DataHoraSolucaoValida, DataHoraSolucao), 120) FROM RAT WHERE RAT.codos = OS.CodOS ORDER BY CodRAT DESC)
																ELSE
																	NULL
															END AS DataFechamento,
															CONVERT(VARCHAR, OS.DataHoraFechamento, 120) AS DataFechamentoSAT,
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT CONVERT(VARCHAR, DataHoraLimiteAtendimento, 120) FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	(SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS)
															END AS DataFimSLA,
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT StatusSLAOS FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																		THEN 'FORA'
																		ELSE 'DENTRO'
																	END
															END AS StatusSLA,
															SLA.NomeSLA AS SLA, StatusServico.NomeStatusServico AS StatusOS, 
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT KMDistancia FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	(SELECT SUBSTRING(dbo.fc_PrazoAtendimentoSLA(OS.CodOS), 23, 5))
															END AS KM,				
															dbo.insertZero(CAST(ISNULL(dbo.fc_CalcDistanciaAdicionalKM(
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT KMDistancia FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	(SELECT SUBSTRING(dbo.fc_PrazoAtendimentoSLA(OS.CodOS), 23, 5))
															END, 85, 65, 60), 0) AS INT) / 60, 2) + ':' +
															dbo.insertZero(CAST(ISNULL(dbo.fc_CalcDistanciaAdicionalKM(
															CASE OS.CodStatusServico
																WHEN 3 THEN
																	(SELECT KMDistancia FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																ELSE
																	(SELECT SUBSTRING(dbo.fc_PrazoAtendimentoSLA(OS.CodOS), 23, 5))
															END, 85, 65, 60), 0) AS INT) % 60, 2
															) AS QtdHorasAcrescimoKM,
															Regiao.NomeRegiao AS Regiao, LocalAtendimento.NumAgencia + '/' + LocalAtendimento.DCPosto AS Agencia, 
															LocalAtendimento.NomeLocal AS _Local, Cidade.NomeCidade AS Cidade, UF.SiglaUF AS UF, e.NomeEquip AS Equipamento, 
															EquipamentoContrato.NumSerie AS NSerie, OS.NumOSQuarteirizada, 
															OS.DefeitoRelatado, OS.ObservacaoCliente AS Observacao, 
															RegiaoAutorizada.PA,				
															(SELECT TOP 1 NumRAT FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC) AS RAT,
															(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad ASC) AS InicioAtendimento,
															(SELECT TOP 1 RelatoSolucao  FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC) AS RelatoSolucao,
															(
																	CASE WHEN 	(
																					SELECT      COUNT(*)
																					FROM        RAT
																					WHERE		RAT.CodRAT IN ( 
																												SELECT		CodRAT
																												FROM		RATDetalhes AS RATDE
																												WHERE		(
																															 RATDE.CodDefeito IN (64,77,79,81,86,91,94,95)
																															 OR			
																															 RATDE.CodAcao IN (5,14,15,16,18,23,24)
																															 OR
																															 RATDE.CodCausa IN (1,7,15,41,69,73,82,241,365,416,427,445,451,459,485,513,517,526,688,820,869,879)
																															)	
																											   )
																					AND			RAT.CodOS = OS.CodOS
																				) &gt; 0

																			THEN ''
																			ELSE 'MQ'
																	END
															) AS MQ,
															(
																	CASE WHEN 	(
																					SELECT      COUNT(*)
																					FROM        RAT
																					WHERE		RAT.CodRAT IN ( 
																												SELECT		CodRAT
																												FROM		RATDetalhes AS RATDE
																												WHERE		(
																															 RATDE.CodDefeito IN (64,77,79,81,86,91,94,95)
																															 OR			
																															 RATDE.CodAcao IN (5,14,15,16,18,23,24)
																															 OR
																															 RATDE.CodCausa IN (1,7,15,41,69,73,82,241,365,416,427,445,451,459,485,513,517,526,688,820,869,879)
																															)	
																											   )
																					AND			RAT.CodOS = OS.CodOS
																				) &gt; 0

																			THEN 'EM'
																			ELSE ''
																	END				
															) AS EM,			
															(
																SELECT			TOP 1 TipoCausa.NomeTipoCausa
																FROM			RATDetalhes 
																INNER JOIN		TipoCausa ON RATDetalhes.CodTipoCausa = TipoCausa.CodTipoCausa
																WHERE			RATDetalhes.CodRAT = (SELECT TOP 1 CodRAT FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC)
																ORDER BY		RATDetalhes.CODRATDetalhe DESC
															) AS CAUSA,
															CASE OS.CodStatusServico 
																WHEN 3 THEN
																	(CASE WHEN (SELECT StatusSLAOS FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) = 'DENTRO'
																		THEN 'NO PRAZO'
																		ELSE 
																			(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) &lt; (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad))
																				THEN 'VENCIDO'
																				ELSE 'NO PRAZO'
																				END)
																		END)
																ELSE
																(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																		THEN	
																			(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad))
																					THEN 'VENCIDO'
																					ELSE 'NO PRAZO'
																					END)
																		ELSE 
																			'NO PRAZO'								
																		END)
																		END				as 'Tempo Resposta',
															(CASE OS.CodStatusServico 
																WHEN 3 THEN
																	CASE WHEN (SELECT TOP 1 DataHoraSolucao FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad desc) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS)
																		THEN '-'
																		ELSE REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS),(SELECT TOP 1 DataHoraSolucao FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad desc))) ),'-','')						
																		END
																ELSE
																	CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																	THEN	
																		(CASE WHEN
																			(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																			THEN 
																				(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																					THEN 
																					(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																						THEN
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																							THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																									THEN 															
																										REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS),GETDATE()))),'-','')
																									ELSE
																										(CASE WHEN
																											(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 	
																											THEN 
																												REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC),(SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS)))),'-','')
																											ELSE 
																												REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC),
																																	(SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS)))),'-','')															
																										END)
															
																									END)
																							ELSE 
																								REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC),(SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS)))),'-','')													
																							END)
																					END)											
																				ELSE		
																				(CASE WHEN
																						(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																							THEN REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS),GETDATE()))),'-','')
																							ELSE 								
																								REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS),GETDATE()))),'-','')
																					END)
																				END)									
																			ELSE									
																				REPLACE(dbo.FN_CONVMIN((DATEDIFF(mi, (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS),GETDATE()))),'-','')
													
																		END)

																	ELSE	
																		'-'
																	END
																END
																) as Atraso,					
															(SELECT Nome FROM Tecnico where CodTecnico = (SELECT TOP 1 CodTecnico FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad DESC)) as Tecnico,
															(CASE OS.CodStatusServico 
																WHEN 3 THEN
																	(CASE WHEN (SELECT StatusSLAOS FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) = 'DENTRO'
																		THEN '-'
																		ELSE 
																			(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) &lt; GETDATE())
																				THEN	
																					(CASE WHEN
																						(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 
																						THEN 
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																								THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 
																									THEN
																										(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													'FALTANTE'
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															'OPERACIONAL' 																				
																														ELSE
																															'FALTANTE'
																													END)
																		
																												END)
																										ELSE 
																											'PEND. FILIAL'													
																										END)
																										ELSE 
																										(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0
																											THEN (CASE WHEN (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) = (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 10 ORDER BY DataHoraCad)
																															THEN 'FALTANTE'
																															ELSE 'PEND. FILIAL'
																															END)
																											ELSE 'PEND. FILIAL'
																											END)
																								END)											
																							ELSE
																								(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													'FALTANTE'
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	'OPERACIONAL COM PEÇA'
																																ELSE
																																	'OPERACIONAL' 																				
																															END)																				
																														ELSE
																															'FALTANTE'
																													END)
																		
																												END)
																										ELSE 
																											(CASE WHEN
																												(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																												THEN 
																													'OPERACIONAL COM PEÇA'
																												ELSE
																													'OPERACIONAL' 																				
																											END)											
																										END)
																							END)									
																						ELSE 
																							(CASE WHEN
																								(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																								THEN 
																									'OPERACIONAL COM PEÇA'
																								ELSE
																									'OPERACIONAL' 																				
																							END)
																					END)

																				ELSE	
																					'-'
																				END)									
																			END)
																ELSE
																	CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																	THEN	
																		(CASE WHEN
																			(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																			THEN 
																				(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																					THEN 
																					(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																						THEN
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																							THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																									THEN 
																										'FALTANTE'
																									ELSE
																										(CASE WHEN
																											(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 	
																											THEN 
																												(CASE WHEN
																													(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																													THEN 
																														'OPERACIONAL COM PEÇA'
																													ELSE
																														'OPERACIONAL' 																				
																												END)
																											ELSE 
																												'FALTANTE'
																										END)
															
																									END)
																							ELSE 
																								'PEND. FILIAL'													
																							END)
																							ELSE 
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0
																											THEN (CASE WHEN (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) = (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 10 ORDER BY DataHoraCad)
																															THEN 'FALTANTE'
																															ELSE 'PEND. FILIAL' 
																															END)
																											ELSE 'PEND. FILIAL'
																											END)
																					END)											
																				ELSE
																					(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													'FALTANTE'
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	'OPERACIONAL COM PEÇA'
																																ELSE
																																	'OPERACIONAL' 																				
																															END)																				
																														ELSE
																															'FALTANTE'
																													END)
																		
																												END)
																										ELSE 
																											(CASE WHEN (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																													THEN	
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	'OPERACIONAL COM PEÇA'
																																ELSE
																																	'OPERACIONAL' 																				
																															END)
																													ELSE	
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	'OPERACIONAL COM PEÇA'
																																ELSE
																																	'OPERACIONAL' 																				
																															END)
																											END)
																										END)
																				END)									
																			ELSE 
																				(CASE WHEN
																					(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																					THEN 
																						'OPERACIONAL COM PEÇA'
																					ELSE
																						'OPERACIONAL' 																				
																				END)
																		END)

																	ELSE	
																		'-'
																	END
																END
															) as Motivo,
															(CASE OS.CodStatusServico 
																WHEN 3 THEN
																	(CASE WHEN (SELECT StatusSLAOS FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) = 'DENTRO'
																		THEN 
																				--'-'
																				OS.DataHoraAberturaOS
																		ELSE 
																			(CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) &lt; GETDATE())
																				THEN	
																					(CASE WHEN
																						(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 
																						THEN 
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																								THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 
																									THEN
																										(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													--'FALTANTE'
																													ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															--'OPERACIONAL' 			
																															OS.DataHoraAberturaOS																	
																														ELSE
																															--'FALTANTE'
																															ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																													END)
																		
																												END)
																										ELSE 
																											--'PEND. FILIAL'	
																											ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)												
																										END)
																										ELSE 
																										(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0
																											THEN (CASE WHEN (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) = (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 10 ORDER BY DataHoraCad)
																															THEN --'FALTANTE'
																																ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																															ELSE --'PEND. FILIAL'
																																ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)
																															END)
																											ELSE --'PEND. FILIAL'
																												 ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)	
																											END)
																								END)											
																							ELSE
																								(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																													--'FALTANTE'
																													ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	--'OPERACIONAL COM PEÇA'
																																	OS.DataHoraAberturaOS
																																ELSE
																																	--'OPERACIONAL' 																				
																																	OS.DataHoraAberturaOS
																															END)																				
																														ELSE
																															--'FALTANTE'
																															ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																													END)
																		
																												END)
																										ELSE 
																											(CASE WHEN
																												(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																												THEN 
																													--'OPERACIONAL COM PEÇA'
																													OS.DataHoraAberturaOS
																												ELSE
																													--'OPERACIONAL' 						
																													OS.DataHoraAberturaOS														
																											END)											
																										END)
																							END)									
																						ELSE 
																							(CASE WHEN
																								(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																								THEN 
																									--'OPERACIONAL COM PEÇA'
																									OS.DataHoraAberturaOS
																								ELSE
																									--'OPERACIONAL' 																				
																									OS.DataHoraAberturaOS
																							END)
																					END)

																				ELSE	
																					--'-'
																					OS.DataHoraAberturaOS
																				END)									
																			END)
																ELSE
																	CASE WHEN ((SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) &lt; GETDATE())
																	THEN	
																		(CASE WHEN
																			(SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																			THEN 
																				(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 7 AND CodOS = OS.CodOS) &gt; 0 
																					THEN 
																					(CASE WHEN (SELECT TOP 1 DataHoraCad FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																						THEN
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																							THEN 
																								(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																									THEN 
																										--'FALTANTE'
																										ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																									ELSE
																										(CASE WHEN
																											(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 	
																											THEN 
																												(CASE WHEN
																													(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																													THEN 
																														--'OPERACIONAL COM PEÇA'
																														OS.DataHoraAberturaOS
																													ELSE
																														--'OPERACIONAL' 																				
																														OS.DataHoraAberturaOS
																												END)
																											ELSE 
																												--'FALTANTE'
																												ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																										END)
															
																									END)
																							ELSE 
																								--'PEND. FILIAL'													
																								ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)
																							END)
																							ELSE 
																							(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0
																											THEN (CASE WHEN (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 7 ORDER BY DataHoraCad) = (SELECT TOP 1 CAST(DataHoraCad AS DATE) FROM HistOS WHERE CodOS = OS.codOS AND CodStatusServico = 10 ORDER BY DataHoraCad)
																															THEN	--'FALTANTE'
																																	ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																															ELSE	--'PEND. FILIAL' 
																																	ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)
																															END)
																											ELSE 
																													--'PEND. FILIAL'
																													ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 7), OS.DataHoraAberturaOS)
																											END)
																					END)											
																				ELSE
																					(CASE WHEN (SELECT COUNT(codos) from HistOS where CodStatusServico = 10 AND CodOS = OS.CodOS) &gt; 0 
																										THEN 
																											(CASE WHEN (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC) IS NULL														
																												THEN 
																														--'FALTANTE'
																														ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																												ELSE
																													(CASE WHEN
																														(SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (12,5,3) AND DataHoraCad &gt; (SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10) ORDER BY DataHoraCad DESC)	&lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSFechada WHERE StatusSLAOSFechada.CodOS = OS.CodOS) 	
																														THEN 
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	--'OPERACIONAL COM PEÇA'
																																	OS.DataHoraAberturaOS
																																ELSE
																																	--'OPERACIONAL' 																				
																																	OS.DataHoraAberturaOS
																															END)																				
																														ELSE
																															--'FALTANTE'
																															ISNULL((SELECT TOP 1 DataHoraCad from HistOS where CodOS = OS.CodOS AND CodStatusServico = 10), OS.DataHoraAberturaOS)
																													END)
																		
																												END)
																										ELSE 
																											(CASE WHEN (SELECT TOP 1 DataHoraInicio FROM RAT WHERE CodOS = OS.codOS ORDER BY DataHoraCad) &lt; (SELECT DataHoraLimiteAtendimento FROM StatusSLAOSAberta WHERE StatusSLAOSAberta.CodOS = OS.CodOS) 
																													THEN	
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	--'OPERACIONAL COM PEÇA'
																																	OS.DataHoraAberturaOS
																																ELSE
																																	--'OPERACIONAL' 																				
																																	OS.DataHoraAberturaOS
																															END)
																													ELSE	
																															(CASE WHEN
																																(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																																THEN 
																																	--'OPERACIONAL COM PEÇA'
																																	OS.DataHoraAberturaOS
																																ELSE
																																	--'OPERACIONAL' 																				
																																	OS.DataHoraAberturaOS
																															END)
																											END)
																										END)
																				END)									
																			ELSE 
																				(CASE WHEN
																					(SELECT COUNT(*) from HistOS where CodOS = OS.CodOS AND CodStatusServico IN (6,7,9,10,11)) &gt; 0
																					THEN 
																						--'OPERACIONAL COM PEÇA'
																						OS.DataHoraAberturaOS
																					ELSE
																						--'OPERACIONAL' 																				
																						OS.DataHoraAberturaOS
																				END)
																		END)

																	ELSE	
																		--'-'
																		OS.DataHoraAberturaOS
																	END
																END
																) as DataFiltro
											FROM			DispBBCalcOS
											INNER JOIN		OS ON DispBBCalcOS.CodOS = OS.CodOS
											INNER JOIN		DispBBEquipamentoContrato EquipamentoContrato ON os.CodEquipContrato = EquipamentoContrato.CodEquipContrato
											INNER JOIN		Contrato ON Contrato.CodContrato = EquipamentoContrato.CodContrato
											INNER JOIN		Cliente ON OS.CodCliente = Cliente.CodCliente
											INNER JOIN		Equipamento e ON e.CodEquip = EquipamentoContrato.CodEquip
											INNER JOIN		LocalAtendimento ON LocalAtendimento.CodPosto = EquipamentoContrato.CodPosto
											INNER JOIN		Filial ON EquipamentoContrato.CodFilial = Filial.CodFilial
											INNER JOIN		Cidade on LocalAtendimento.CodCidade = Cidade.CodCidade
											INNER JOIN		UF ON UF.CodUF = Cidade.CodUF
											INNER JOIN		DispBBCriticidade dc ON EquipamentoContrato.CodSLA = dc.CodSLA
											INNER JOIN		DispBBRegiaoUF duf ON UF.CodUF = duf.CodUF
											INNER JOIN		DispBBRegiao dr ON duf.CodDispBBRegiao = dr.CodDispBBRegiao
											INNER JOIN		TipoIntervencao ON OS.CodTipoIntervencao = TipoIntervencao.CodTipoIntervencao
											INNER JOIN		StatusServico ON OS.CodStatusServico = StatusServico.CodStatusServico
											LEFT OUTER JOIN Autorizada ON OS.CodAutorizada = Autorizada.CodAutorizada
											LEFT OUTER JOIN Regiao ON OS.CodRegiao = Regiao.CodRegiao
											LEFT OUTER JOIN SLA ON EquipamentoContrato.CodSLA = SLA.CodSLA
											INNER JOIN		RegiaoAutorizada ON EquipamentoContrato.CodRegiao = RegiaoAutorizada.CodRegiao AND EquipamentoContrato.CodAutorizada = RegiaoAutorizada.CodAutorizada 
															AND RegiaoAutorizada.CodFilial NOT in (7, 21) 
											WHERE			DispBBCalcOS.AnoMes = @AnoMes
											AND				EquipamentoContrato.AnoMes = @AnoMes
										) AS DADOS
					INNER JOIN			OS ON DADOS.OS = OS.CodOS
					INNER JOIN			DispBBCalcOS ON OS.CodOS = DispBBCalcOS.CodOS
					INNER JOIN			DispBBEquipamentoContrato ec ON os.CodEquipContrato = ec.CodEquipContrato
					INNER JOIN			LocalAtendimento lc ON lc.CodPosto = ec.CodPosto
					INNER JOIN			Cidade ci on lc.CodCidade = ci.CodCidade
					INNER JOIN			UF ON UF.CodUF = ci.CodUF
					INNER JOIN			DispBBCriticidade dc ON ec.CodSLA = dc.CodSLA
					WHERE				DispBBCalcOS.AnoMes = @AnoMes
					AND					EC.AnoMes = @AnoMes
				) AS SINTETICO
WHERE			Motivo &lt;&gt; '-'
GROUP BY		FILIAL</CommandText>
        <rd:UseGenericDesigner>true</rd:UseGenericDesigner>
      </Query>
      <Fields>
        <Field Name="FILIAL">
          <DataField>FILIAL</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="Motivo">
          <DataField>Motivo</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="Chamados">
          <DataField>Chamados</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="Indisponibilidade">
          <DataField>Indisponibilidade</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="TEMPO_MÉDIO">
          <DataField>TEMPO MÉDIO</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="DsAnos">
      <Query>
        <DataSourceName>SAT</DataSourceName>
        <CommandText>WITH Anos AS
(
  SELECT 2015 AS IdAno
  UNION ALL
  SELECT IdAno + 1
  FROM Anos
  WHERE IdAno &lt; YEAR(GETDATE())
)
SELECT * FROM Anos</CommandText>
      </Query>
      <Fields>
        <Field Name="IdAno">
          <DataField>IdAno</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="DsMeses">
      <Query>
        <DataSourceName>SAT</DataSourceName>
        <CommandText>WITH Meses AS
(
  SELECT 1 AS IdMes
  UNION ALL
  SELECT IdMes + 1
  FROM Meses
  WHERE IdMes &lt; 12
)
SELECT dbo.insertZero(IdMes, 2) IdMes FROM Meses</CommandText>
      </Query>
      <Fields>
        <Field Name="IdMes">
          <DataField>IdMes</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
  </DataSets>
  <ReportParameters>
    <ReportParameter Name="ANO">
      <DataType>String</DataType>
      <Prompt>Ano:</Prompt>
      <ValidValues>
        <DataSetReference>
          <DataSetName>DsAnos</DataSetName>
          <ValueField>IdAno</ValueField>
          <LabelField>IdAno</LabelField>
        </DataSetReference>
      </ValidValues>
    </ReportParameter>
    <ReportParameter Name="MES">
      <DataType>String</DataType>
      <Prompt>Mês:</Prompt>
      <ValidValues>
        <DataSetReference>
          <DataSetName>DsMeses</DataSetName>
          <ValueField>IdMes</ValueField>
          <LabelField>IdMes</LabelField>
        </DataSetReference>
      </ValidValues>
    </ReportParameter>
  </ReportParameters>
  <Language>en-US</Language>
  <ConsumeContainerWhitespace>true</ConsumeContainerWhitespace>
  <rd:ReportUnitType>Inch</rd:ReportUnitType>
  <rd:ReportID>1ba01b4f-7c04-4e03-9670-1beb001d5219</rd:ReportID>
</Report>